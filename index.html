<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FC-Series Live Monitor</title>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; background: #f4f7f6; }
        .card { background: white; max-width: 400px; margin: 20px auto; padding: 20px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); text-align: left; }
        .value { float: right; color: #1a73e8; font-weight: bold; font-size: 1.2em; }
        .metric { margin: 15px 0; border-bottom: 1px solid #eee; padding-bottom: 8px; }
        #scan-btn { background: #1a73e8; color: white; border: none; padding: 15px 30px; border-radius: 25px; font-size: 16px; cursor: pointer; }
        .debug { background: #222; color: #0f0; padding: 10px; font-family: monospace; font-size: 11px; margin-top: 20px; border-radius: 5px; word-break: break-all; }
    </style>
</head>
<body>
    <h1>FC-009SM Monitor</h1>
    <button id="scan-btn">START SCANNING</button>
    <p id="status">Status: Ready</p>

    <div class="card" id="display" style="display:none;">
        <div class="metric">Temperature: <span class="value" id="t-v">--</span></div>
        <div class="metric">Humidity: <span class="value" id="h-v">--</span></div>
        <div class="metric">Battery: <span class="value" id="b-v">--</span></div>
        <div class="debug" id="raw">Waiting for signal...</div>
    </div>

    <script>
        const btn = document.getElementById('scan-btn');
        const st = document.getElementById('status');

        btn.addEventListener('click', async () => {
            try {
                st.innerText = "Requesting device...";
                // Filtering for your specific FC- brand
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ namePrefix: 'FC-' }],
                    optionalServices: ['battery_service']
                });

                document.getElementById('display').style.display = "block";
                st.innerText = "Connecting to " + device.name + "...";

                // CRITICAL: This requires the chrome://flags to be enabled
                if (!device.watchAdvertisements) {
                    st.innerText = "Error: Enable 'Experimental Web Platform features' in chrome://flags";
                    return;
                }

                await device.watchAdvertisements();
                st.innerText = "Listening for advertisements...";

                device.addEventListener('advertisementreceived', (event) => {
                    st.innerText = "Data Updated: " + new Date().toLocaleTimeString();
                    
                    // Look for data in both common BLE slots
                    let data = event.manufacturerData.get(Array.from(event.manufacturerData.keys())[0]) 
                               || event.serviceData.get(Array.from(event.serviceData.keys())[0]);

                    if (data) {
                        // 1. Show the Raw Hex for us to debug
                        let hex = Array.from(new Uint8Array(data.buffer)).map(b => b.toString(16).padStart(2,'0')).join(' ');
                        document.getElementById('raw').innerText = "Raw Hex: " + hex;

                        // 2. Parse the bytes (Adjust positions if values look wrong)
                        if (data.byteLength >= 3) {
                            document.getElementById('t-v').innerText = data.getUint8(0) + "Â°C";
                            document.getElementById('h-v').innerText = data.getUint8(1) + "%";
                            document.getElementById('b-v').innerText = (data.getUint8(2)/10).toFixed(1) + "V";
                        }
                    }
                });
            } catch (e) {
                st.innerText = "Error: " + e.message;
            }
        });
    </script>
</body>
</html>
